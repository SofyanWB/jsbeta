"use strict";(self.webpackChunkjakartasatubeta=self.webpackChunkjakartasatubeta||[]).push([[7463],{97463:function(e,t,r){r.r(t),r.d(t,{createConnection:function(){return M}});var n=r(37762),o=r(74165),s=r(15861),i=r(1413),a=r(15671),c=r(43144),u=r(60136),l=r(29388),f=r(27366),h=(r(59486),r(76200)),d=r(10064),v=r(32718),p=r(66978),g=r(35995),y=(r(25243),r(63780),r(93169),r(69912)),k=r(11752),_=r(61120),w=r(49861),Z=r(93501),b=function(e){(0,u.Z)(r,e);var t=(0,l.Z)(r);function r(){return(0,a.Z)(this,r),t.apply(this,arguments)}return(0,c.Z)(r,[{key:"destroy",value:function(){this.emit("destroy")}},{key:"connectionError",get:function(){return this.errorString?new d.Z("stream-connection",this.errorString):null}},{key:"onFeature",value:function(e){this.emit("data-received",e)}},{key:"onMessage",value:function(e){this.emit("message-received",e)}}]),r}(r(91505).Z.EventedAccessor);(0,f._)([(0,w.Cb)({readOnly:!0})],b.prototype,"connectionError",null);var m,S,x=b=(0,f._)([(0,y.j)("esri.layers.support.StreamConnection")],b);(S=m||(m={}))[S.CONNECTING=0]="CONNECTING",S[S.OPEN=1]="OPEN",S[S.CLOSING=2]="CLOSING",S[S.CLOSED=3]="CLOSED";var C=function(e){(0,u.Z)(r,e);var t=(0,l.Z)(r);function r(e){var n;(0,a.Z)(this,r),(n=t.call(this))._outstandingMessages=[],n.errorString=null;var o=e.geometryType,s=e.spatialReference,i=e.sourceSpatialReference;return n._config=e,n._featureZScaler=(0,Z.k)(o,i,s),n._open(),n}return(0,c.Z)(r,[{key:"_open",value:function(){var e=(0,s.Z)((0,o.Z)().mark((function e(){return(0,o.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._tryCreateWebSocket();case 2:if(e.t0=this.destroyed,e.t0){e.next=6;break}return e.next=6,this._handshake();case 6:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"destroy",value:function(){(0,k.Z)((0,_.Z)(r.prototype),"destroy",this).call(this),null!=this._websocket&&(this._websocket.onopen=null,this._websocket.onclose=null,this._websocket.onerror=null,this._websocket.onmessage=null,this._websocket.close()),this._websocket=null}},{key:"connectionStatus",get:function(){if(null==this._websocket)return"disconnected";switch(this._websocket.readyState){case m.CONNECTING:case m.OPEN:return"connected";case m.CLOSING:case m.CLOSED:return"disconnected"}}},{key:"sendMessageToSocket",value:function(e){null!=this._websocket?this._websocket.send(JSON.stringify(e)):this._outstandingMessages.push(e)}},{key:"sendMessageToClient",value:function(e){this._onMessage(e)}},{key:"updateCustomParameters",value:function(e){this._config.customParameters=e,null!=this._websocket&&this._websocket.close()}},{key:"_tryCreateWebSocket",value:function(){var e=(0,s.Z)((0,o.Z)().mark((function e(){var t,r,n,s,i,a,c=arguments;return(0,o.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=c.length>0&&void 0!==c[0]?c[0]:this._config.source.path,r=c.length>1&&void 0!==c[1]?c[1]:1e3,n=c.length>2&&void 0!==c[2]?c[2]:0,e.prev=3,!this.destroyed){e.next=6;break}return e.abrupt("return");case 6:return i=(0,g.fl)(t,null!==(s=this._config.customParameters)&&void 0!==s?s:{}),e.next=9,this._createWebSocket(i);case 9:this._websocket=e.sent,this.notifyChange("connectionStatus"),e.next=25;break;case 13:if(e.prev=13,e.t0=e.catch(3),a=r/1e3,!(this._config.maxReconnectionAttempts&&n>=this._config.maxReconnectionAttempts)){e.next=20;break}e.t1=(v.Z.getLogger(this).error(new d.Z("websocket-connection","Exceeded maxReconnectionAttempts attempts. No further attempts will be made")),void this.destroy()),e.next=24;break;case 20:return v.Z.getLogger(this).error(new d.Z("websocket-connection","Failed to connect. Attempting to reconnect in ".concat(a,"s"),e.t0)),e.next=23,(0,p.e4)(r);case 23:e.t1=this._tryCreateWebSocket(t,Math.min(1.5*r,1e3*this._config.maxReconnectionInterval),n+1);case 24:return e.abrupt("return",e.t1);case 25:case"end":return e.stop()}}),e,this,[[3,13]])})));return function(){return e.apply(this,arguments)}}()},{key:"_setWebSocketJSONParseHandler",value:function(e){var t=this;e.onmessage=function(e){try{var r=JSON.parse(e.data);t._onMessage(r)}catch(n){return void v.Z.getLogger(t).error(new d.Z("websocket-connection","Failed to parse message, invalid JSON",{error:n}))}}}},{key:"_createWebSocket",value:function(e){var t=this;return new Promise((function(r,n){var o=new WebSocket(e);o.onopen=function(){if(o.onopen=null,t.destroyed)return o.onclose=null,void o.close();o.onclose=function(e){return t._onClose(e)},o.onerror=function(e){return t._onError(e)},t._setWebSocketJSONParseHandler(o),r(o)},o.onclose=function(e){o.onopen=o.onclose=null,n(e)}}))}},{key:"_handshake",value:function(){var e=(0,s.Z)((0,o.Z)().mark((function e(){var t,r,s,i,a,c,u,l,f=this,h=arguments;return(0,o.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=h.length>0&&void 0!==h[0]?h[0]:1e4,null!=(r=this._websocket)){e.next=4;break}return e.abrupt("return");case 4:return s=(0,p.hh)(),i=r.onmessage,a=this._config,c=a.filter,u=a.outFields,l=a.spatialReference,e.abrupt("return",(s.timeout(t),r.onmessage=function(e){var t,o=null;try{o=JSON.parse(e.data)}catch(m){}o&&"object"==typeof o||(v.Z.getLogger(f).error(new d.Z("websocket-connection","Protocol violation. Handshake failed - malformed message",e.data)),s.reject(),f.destroy()),(null===(t=o.spatialReference)||void 0===t?void 0:t.wkid)!==(null===l||void 0===l?void 0:l.wkid)&&(v.Z.getLogger(f).error(new d.Z("websocket-connection","Protocol violation. Handshake failed - expected wkid of ".concat(l.wkid),e.data)),s.reject(),f.destroy()),"json"!==o.format&&(v.Z.getLogger(f).error(new d.Z("websocket-connection","Protocol violation. Handshake failed - format is not set",e.data)),s.reject(),f.destroy()),c&&o.filter!==c&&v.Z.getLogger(f).error(new d.Z("websocket-connection","Tried to set filter, but server doesn't support it")),u&&o.outFields!==u&&v.Z.getLogger(f).error(new d.Z("websocket-connection","Tried to set outFields, but server doesn't support it")),r.onmessage=i;var a,h=(0,n.Z)(f._outstandingMessages);try{for(h.s();!(a=h.n()).done;){var p=a.value;r.send(JSON.stringify(p))}}catch(g){h.e(g)}finally{h.f()}f._outstandingMessages=[],s.resolve()},r.send(JSON.stringify({filter:c,outFields:u,format:"json",spatialReference:{wkid:l.wkid}})),s.promise));case 6:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"_onMessage",value:function(e){if(this.onMessage(e),"type"in e)switch(e.type){case"features":case"featureResult":var t,r=(0,n.Z)(e.features);try{for(r.s();!(t=r.n()).done;){var o=t.value;null!=this._featureZScaler&&this._featureZScaler(o.geometry),this.onFeature(o)}}catch(s){r.e(s)}finally{r.f()}}}},{key:"_onError",value:function(e){var t="Encountered an error over WebSocket connection";this._set("errorString",t),v.Z.getLogger(this).error("websocket-connection",t)}},{key:"_onClose",value:function(e){this._websocket=null,this.notifyChange("connectionStatus"),1e3!==e.code&&v.Z.getLogger(this).error("websocket-connection","WebSocket closed unexpectedly with error code ".concat(e.code)),this.destroyed||this._open()}}]),r}(x);(0,f._)([(0,w.Cb)()],C.prototype,"connectionStatus",null),(0,f._)([(0,w.Cb)()],C.prototype,"errorString",void 0),C=(0,f._)([(0,y.j)("esri.layers.graphics.sources.connections.WebSocketConnection")],C);var F=r(5192),R=r(21149),N=r(77981),L=r(78952),O={maxQueryDepth:5,maxRecordCountFactor:3},E=function(e){(0,u.Z)(f,e);var t=(0,l.Z)(f);function f(e){var r;return(0,a.Z)(this,f),(r=t.call(this,(0,i.Z)((0,i.Z)({},O),e)))._buddyServicesQuery=null,r._relatedFeatures=null,r}return(0,c.Z)(f,[{key:"_open",value:function(){var e=(0,s.Z)((0,o.Z)().mark((function e(){var t,r,n,s,i;return(0,o.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._fetchServiceDefinition(this._config.source);case 2:return(t=e.sent).timeInfo.trackIdField||v.Z.getLogger(this).warn("GeoEvent service was configured without a TrackIdField. This may result in certain functionality being disabled. The purgeOptions.maxObservations property will have no effect."),r=this._fetchWebSocketUrl(t.streamUrls,this._config.spatialReference),this._buddyServicesQuery||(this._buddyServicesQuery=this._queryBuddyServices()),e.next=8,this._buddyServicesQuery;case 8:return e.next=10,this._tryCreateWebSocket(r);case 10:n=this._config,s=n.filter,i=n.outFields,this.destroyed||this._setFilter(s,i);case 12:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"_onMessage",value:function(e){if("attributes"in e){var t;try{t=this._enrich(e),null!=this._featureZScaler&&this._featureZScaler(t.geometry)}catch(r){return void v.Z.getLogger(this).error(new d.Z("geoevent-connection","Failed to parse message",r))}this.onFeature(t)}else this.onMessage(e)}},{key:"_fetchServiceDefinition",value:function(){var e=(0,s.Z)((0,o.Z)().mark((function e(t){var r,n,s;return(0,o.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=(0,i.Z)({f:"json"},this._config.customParameters),n=(0,h.default)(t.path,{query:r,responseType:"json"}),e.next=4,n;case 4:return s=e.sent.data,e.abrupt("return",(this._serviceDefinition=s,s));case 6:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_fetchWebSocketUrl",value:function(e,t){var r=e[0],n=r.urls,o=r.token,s=this._inferWebSocketBaseUrl(n);return(0,g.fl)("".concat(s,"/subscribe"),{outSR:""+t.wkid,token:o})}},{key:"_inferWebSocketBaseUrl",value:function(e){if(1===e.length)return e[0];var t,r=(0,n.Z)(e);try{for(r.s();!(t=r.n()).done;){var o=t.value;if(o.includes("wss"))return o}}catch(s){r.e(s)}finally{r.f()}return v.Z.getLogger(this).error(new d.Z("geoevent-connection","Unable to infer WebSocket url",e)),null}},{key:"_setFilter",value:function(){var e=(0,s.Z)((0,o.Z)().mark((function e(t,r){var n,s,i,a,c,u,l=this;return(0,o.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null!=(n=this._websocket)&&(null!=t||null!=r)){e.next=3;break}return e.abrupt("return");case 3:return s=JSON.stringify({filter:this._serializeFilter(t,r)}),i=!1,a=(0,p.hh)(),c=function(){i||(l.destroyed||l._websocket!==n||v.Z.getLogger(l).error(new d.Z("geoevent-connection","Server timed out when setting filter")),a.reject())},u=function(e){var t=JSON.parse(e.data);t.filter&&(t.error&&(v.Z.getLogger(l).error(new d.Z("geoevent-connection","Failed to set service filter",t.error)),l._set("errorString","Could not set service filter - ".concat(t.error)),a.reject(t.error)),l._setWebSocketJSONParseHandler(n),i=!0,a.resolve())},e.abrupt("return",(n.onmessage=u,n.send(s),setTimeout(c,1e4),a.promise));case 7:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"_serializeFilter",value:function(e,t){var r={};if(null==e&&null==t)return r;if(null!=e&&e.geometry)try{var n=(0,N.im)(e.geometry);if("extent"!==n.type)throw new d.Z("Expected extent but found type ".concat(n.type));r.geometry=JSON.stringify(n.shiftCentralMeridian())}catch(x){v.Z.getLogger(this).error(new d.Z("geoevent-connection","Encountered an error when setting connection geometryDefinition",x))}return null!=e&&e.where&&"1 = 1"!==e.where&&"1=1"!==e.where&&(r.where=e.where),null!=t&&(r.outFields=t.join(",")),r}},{key:"_enrich",value:function(e){if(!this._relatedFeatures)return e;var t=this._serviceDefinition.relatedFeatures.joinField,r=e.attributes[t],n=this._relatedFeatures.get(r);if(!n)return v.Z.getLogger(this).warn("geoevent-connection","Feature join failed. Is the join field configured correctly?",e),e;var o=n.attributes,s=n.geometry;for(var i in o)e.attributes[i]=o[i];return s&&(e.geometry=s),e.geometry||e.centroid||v.Z.getLogger(this).error(new d.Z("geoevent-connection","Found malformed feature - no geometry found",e)),e}},{key:"_queryBuddyServices",value:function(){var e=(0,s.Z)((0,o.Z)().mark((function e(){var t,r,s,i,a,c,u,l,f;return(0,o.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,t=this._serviceDefinition,r=t.relatedFeatures,s=t.keepLatestArchive,i=this._queryRelatedFeatures(r),a=this._queryArchive(s),e.next=4,i;case 4:return e.next=6,a;case 6:if(c=e.sent){e.next=9;break}return e.abrupt("return");case 9:u=(0,n.Z)(c.features);try{for(u.s();!(l=u.n()).done;)f=l.value,this.onFeature(this._enrich(f))}catch(o){u.e(o)}finally{u.f()}e.next=16;break;case 13:e.prev=13,e.t0=e.catch(0),v.Z.getLogger(this).error(new d.Z("geoevent-connection","Encountered an error when querying buddy services",{error:e.t0}));case 16:case"end":return e.stop()}}),e,this,[[0,13]])})));return function(){return e.apply(this,arguments)}}()},{key:"_queryRelatedFeatures",value:function(){var e=(0,s.Z)((0,o.Z)().mark((function e(t){var r;return(0,o.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t){e.next=2;break}return e.abrupt("return");case 2:return e.next=4,this._queryBuddy(t.featuresUrl);case 4:r=e.sent,this._addRelatedFeatures(r);case 6:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_queryArchive",value:function(){var e=(0,s.Z)((0,o.Z)().mark((function e(t){return(0,o.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!t){e.next=2;break}return e.abrupt("return",this._queryBuddy(t.featuresUrl));case 2:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_queryBuddy",value:function(){var e=(0,s.Z)((0,o.Z)().mark((function e(t){var n,s,i,a,c,u,l,f,h,d,v,p,g,y;return(0,o.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Promise.resolve().then(r.bind(r,64326));case 2:return e.t0=e.sent.default,e.t1={url:t},a=new e.t0(e.t1),e.next=7,a.load();case 7:if(c=e.sent,u=c.capabilities,l=u.query.supportsMaxRecordCountFactor,f=u.query.supportsPagination,h=u.query.supportsCentroid,d=this._config.maxRecordCountFactor,v=a.capabilities.query.maxRecordCount,p=l?v*d:v,(g=new R.Z).outFields=null!==(n=this._config.outFields)&&void 0!==n?n:["*"],g.where=null!==(s=null===(i=this._config.filter)||void 0===i?void 0:i.where)&&void 0!==s?s:"1=1",g.returnGeometry=!0,g.returnExceededLimitFeatures=!0,g.outSpatialReference=L.Z.fromJSON(this._config.spatialReference),h&&(g.returnCentroid=!0),l&&(g.maxRecordCountFactor=d),!f){e.next=18;break}return e.abrupt("return",(g.num=p,a.destroy(),this._queryPages(t,g)));case 18:return e.next=20,(0,F.JT)(t,g,this._config.sourceSpatialReference);case 20:return y=e.sent,e.abrupt("return",(a.destroy(),y.data));case 22:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_queryPages",value:function(){var e=(0,s.Z)((0,o.Z)().mark((function e(t,r){var n,s,i,a,c,u=arguments;return(0,o.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return s=u.length>2&&void 0!==u[2]?u[2]:[],i=u.length>3&&void 0!==u[3]?u[3]:0,r.start=null!=r.num?i*r.num:null,e.next=5,(0,F.JT)(t,r,this._config.sourceSpatialReference);case 5:return a=e.sent,c=a.data,e.abrupt("return",c.exceededTransferLimit&&i<(null!==(n=this._config.maxQueryDepth)&&void 0!==n?n:0)?(c.features.forEach((function(e){return s.push(e)})),this._queryPages(t,r,s,i+1)):(s.forEach((function(e){return c.features.push(e)})),c));case 8:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"_addRelatedFeatures",value:function(e){var t,r=new Map,o=e.features,s=this._serviceDefinition.relatedFeatures.joinField,i=(0,n.Z)(o);try{for(i.s();!(t=i.n()).done;){var a=t.value,c=a.attributes[s];r.set(c,a)}}catch(u){i.e(u)}finally{i.f()}this._relatedFeatures=r}}]),f}(C),j=E=(0,f._)([(0,y.j)("esri.layers.graphics.sources.connections.GeoEventConnection")],E),P=function(e){(0,u.Z)(r,e);var t=(0,l.Z)(r);function r(e){var n;(0,a.Z)(this,r),(n=t.call(this)).connectionStatus="connected",n.errorString=null;var o=e.geometryType,s=e.spatialReference,i=e.sourceSpatialReference;return n._featureZScaler=(0,Z.k)(o,i,s),n}return(0,c.Z)(r,[{key:"updateCustomParameters",value:function(e){}},{key:"sendMessageToSocket",value:function(e){}},{key:"sendMessageToClient",value:function(e){if("type"in e)switch(e.type){case"features":case"featureResult":var t,r=(0,n.Z)(e.features);try{for(r.s();!(t=r.n()).done;){var o=t.value;null!=this._featureZScaler&&this._featureZScaler(o.geometry),this.onFeature(o)}}catch(s){r.e(s)}finally{r.f()}}this.onMessage(e)}}]),r}(x);function M(e,t,r,n,o,s,i,a){var c={source:e,sourceSpatialReference:t,spatialReference:r,geometryType:n,filter:o,maxReconnectionAttempts:s,maxReconnectionInterval:i,customParameters:a};return e?e.path.startsWith("wss://")||e.path.startsWith("ws://")?new C(c):new j(c):new P(c)}(0,f._)([(0,w.Cb)()],P.prototype,"connectionStatus",void 0),(0,f._)([(0,w.Cb)()],P.prototype,"errorString",void 0),P=(0,f._)([(0,y.j)("esri.layers.support.ClientSideConnection")],P)}}]);
//# sourceMappingURL=7463.81f06fa8.chunk.js.map